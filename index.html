<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LinkedIn Connect</title>
  <style>
    :root {
      --bg: #0f172a;
      /* slate-900 */
      --bg2: #111827;
      /* gray-900 */
      --card: #0b1220;
      --text: #e5e7eb;
      /* gray-200 */
      --muted: #9ca3af;
      /* gray-400 */
      --primary: #6366f1;
      /* indigo-500 */
      --primary-600: #4f46e5;
      --accent: #22c55e;
      /* green-500 */
      --border: #1f2937;
      /* gray-800 */
      --shadow: rgba(99, 102, 241, 0.25);
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(99, 102, 241, .15), transparent 50%),
        radial-gradient(800px 400px at 90% 10%, rgba(34, 197, 94, .12), transparent 50%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", sans-serif;
    }

    .container {
      max-width: 880px;
      margin: 28px auto;
      padding: 0 20px
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 14px
    }

    .logo {
      width: 40px;
      height: 40px;
      display: grid;
      place-items: center;
      border-radius: 10px;
      background: rgba(99, 102, 241, .15);
      border: 1px solid rgba(99, 102, 241, .35)
    }

    .brand h1 {
      font-size: 24px;
      margin: 0;
      background: linear-gradient(90deg, #a5b4fc, #93c5fd);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent
    }

    .subtitle {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 13px
    }

    .card {
      background: linear-gradient(180deg, rgba(12, 18, 32, .88), rgba(12, 18, 32, .78));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin: 12px 0;
      box-shadow: 0 10px 30px var(--shadow);
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }

    .row .grow {
      flex: 1 1 240px
    }

    label {
      display: block;
      font-size: 13px;
      margin: 10px 0 6px;
      color: #cbd5e1
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 11px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      color: var(--text);
      background: #0a0f1b;
      transition: border-color .2s, box-shadow .2s, transform .06s ease;
    }

    input::placeholder,
    textarea::placeholder {
      color: #6b7280
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-600);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, .25);
      transform: translateY(-0.5px);
    }

    textarea {
      min-height: 112px
    }

    .muted {
      color: var(--muted);
      font-size: 12px
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 14px
    }

    button {
      appearance: none;
      border: 0;
      border-radius: 10px;
      padding: 10px 16px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(180deg, var(--primary), var(--primary-600));
      color: #fff;
      box-shadow: 0 8px 16px rgba(79, 70, 229, .35);
      transition: transform .08s ease, filter .15s ease, box-shadow .15s ease;
    }

    button:hover {
      filter: brightness(0.96);
      box-shadow: 0 10px 20px rgba(79, 70, 229, .45)
    }

    button:active {
      transform: translateY(1px);
    }

    button[disabled] {
      opacity: .6;
      cursor: not-allowed;
      box-shadow: none
    }

    .msg {
      margin-top: 10px;
      font-size: 13px
    }

    .ok {
      color: #10b981;
      background: #064e3b20;
      padding: 3px 8px;
      border: 1px solid #10b98140;
      border-radius: 8px
    }

    .err {
      color: #ef4444;
      background: #7f1d1d20;
      padding: 3px 8px;
      border: 1px solid #ef444440;
      border-radius: 8px
    }

    .list {
      list-style: none;
      margin: 8px 0 0;
      padding: 0
    }

    .item {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-top: 8px;
      background: #0a0f1b
    }

    .section-title {
      font-size: 16px;
      margin: 0 0 8px;
      color: #a5b4fc;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 18px 0
    }

    .radio-row {
      display: flex;
      gap: 12px;
      padding: 8px 10px;
      background: #0a0f1b;
      border: 1px solid var(--border);
      border-radius: 10px
    }

    .radio-row label {
      margin: 0;
      font-size: 13px;
      color: #cbd5e1
    }

    /* Verification Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      display: none;
      z-index: 50;
      backdrop-filter: blur(2px);
    }

    .modal {
      width: 360px;
      max-width: calc(100% - 32px);
      background: #0a0f1b;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 12px 30px var(--shadow);
      margin: 80px auto;
      padding: 16px;
      color: var(--text);
    }

    .modal h3 {
      margin: 0 0 8px;
      font-size: 16px;
      color: #a5b4fc
    }

    .modal .muted {
      margin: 0 0 10px
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 12px
    }

    .btn-secondary {
      background: #1f2937;
      box-shadow: none
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="brand">
      <div class="logo">
        <!-- Simple LinkedIn SVG icon -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true">
          <rect x="3" y="3" width="18" height="18" rx="4" fill="#2563eb" />
          <rect x="6" y="9" width="2.8" height="9" fill="white" />
          <circle cx="7.4" cy="6.7" r="1.4" fill="white" />
          <path
            d="M12.7 10.5c1.9 0 3 1.1 3 3.2v4.3h-2.8v-3.8c0-.9-.4-1.5-1.3-1.5-.8 0-1.3.6-1.3 1.5v3.8H7.4v-9h2.7v1.3c.6-.9 1.4-1.3 2.6-1.3Z"
            fill="white" />
        </svg>
      </div>
      <div>
        <h1>LinkedIn Connect</h1>
        <p class="subtitle">Connect your account with credentials or cookies, then manage it in one place.</p>
      </div>
    </div>

    <!-- Connect Section -->
    <div class="card" id="connect">
      <p class="muted">Choose a method below. If credentials flow requests a verification code, enter it and submit
        again.</p>
      <div class="row">
        <div class="grow">
          <label>Name *</label>
          <input id="name" placeholder="Your Name" />
        </div>
        <div class="grow">
          <label>Email *</label>
          <input id="email" type="email" placeholder="you@example.com" />
        </div>
      </div>

      <label>Connection method</label>
      <div class="radio-row">
        <label><input type="radio" name="method" value="credentials" checked /> Credentials</label>
        <label><input type="radio" name="method" value="cookies" /> Cookies</label>
      </div>

      <div id="cred-fields">
        <label>LinkedIn Username/Email *</label>
        <input id="username" placeholder="linkedin@example.com" />
        <label>LinkedIn Password *</label>
        <input id="password" type="password" placeholder="Enter your password" />
      </div>

      <div id="cookie-fields" style="display:none;">
        <label>LinkedIn Cookies *</label>
        <textarea id="cookies"
          placeholder="Paste the full Cookie header from www.linkedin.com after login (must include li_at)"></textarea>
      </div>

      <div id="code-fields" style="display:none;">
        <label>Verification code (only if requested)</label>
        <input id="verificationCode" placeholder="6-digit code" />
        <p class="muted">If the previous response requested a verification code, enter it and submit again.</p>
      </div>

      <div class="actions">
        <button id="connect-btn">Connect</button>
      </div>
      <div id="connect-msg" class="msg"></div>
    </div>

    <div class="divider"></div>

    <!-- Linked Accounts -->
    <div class="card" id="accounts">
      <h2 class="section-title">Linked Accounts</h2>
      <div class="row">
        <div class="grow">
          <label>Email *</label>
          <input id="accounts-email" type="email" placeholder="Use the same email to fetch" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="accounts-btn">Fetch</button>
        </div>
      </div>
      <div id="accounts-msg" class="msg"></div>
      <ul id="accounts-list" class="list"></ul>
    </div>
  </div>

  <script>
    // ?��?????��?
    // 切換顯示的共用方法
    function updateMethodUI() {
      const selected = document.querySelector('input[name="method"]:checked')?.value;
      const isCred = selected === 'credentials';
      const credEl = document.getElementById('cred-fields');
      const cookieEl = document.getElementById('cookie-fields');
      if (credEl) credEl.style.display = isCred ? 'block' : 'none';
      if (cookieEl) cookieEl.style.display = isCred ? 'none' : 'block';
    }

    // 綁定 change 與 click 事件，確保切換立即生效
    document.querySelectorAll('input[name="method"]').forEach(r => {
      ['change', 'click'].forEach(evt => r.addEventListener(evt, updateMethodUI));
    });

    // 初始化：依目前選擇的方式設定顯示/隱藏
    document.addEventListener('DOMContentLoaded', updateMethodUI);

    // ?�出???
    document.getElementById('connect-btn').addEventListener('click', async () => {
      const btn = document.getElementById('connect-btn');
      const msg = document.getElementById('connect-msg');
      msg.textContent = '';
      btn.disabled = true;

      const name = (document.getElementById('name').value || '').trim();
      const email = (document.getElementById('email').value || '').trim();
      const method = document.querySelector('input[name="method"]:checked').value;
      const payload = { name, email, method };

      if (method === 'credentials') {
        payload.username = (document.getElementById('username').value || '').trim();
        payload.password = document.getElementById('password').value || '';
        const code = (document.getElementById('verificationCode').value || '').trim();
        if (code) payload.verificationCode = code;
      } else {
        payload.cookies = (document.getElementById('cookies').value || '').trim();
      }

      try {
        const res = await fetch('/api/linkedin/connect', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        const status = res.status;
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { message: text }; }

        if (!res.ok) {
          console.error(`API Error - Status: ${status}, Body: ${text}`);
        }

        const isOk = res.ok;
        if (isOk && (data.success || (data.account_id || (data.data && data.data.account_id)))) {
          const id = data.account_id || (data.data && data.data.account_id) || '';
          msg.innerHTML = `<span class="ok">Connected successfully</span>${id ? `, Account ID: ${id}` : ''}`;
          document.getElementById('verificationCode').value = '';
          document.getElementById('code-fields').style.display = 'none';
          // Also hide modal if it was open
          const m = document.getElementById('code-modal'); if (m) m.style.display = 'none';
        } else {
          const err = data.error || data.message || `Connection failed (HTTP ${status})`;
          msg.innerHTML = `<span class="err">${err}</span>`;
          if (method === 'credentials') {
            // Show verification modal instead of inline fields
            showCodeModal();
          }
        }
      } catch (e) {
        console.error('API Error - Network/Fetch Failed:', e);
        msg.innerHTML = `<span class="err">Submit failed: ${e.message}</span>`;
      } finally {
        btn.disabled = false;
      }

      // �?Email ?�步?�查詢�?塊�?便於使用?�直?�查�?      document.getElementById('accounts-email').value = email;
    });

    document.getElementById('accounts-btn').addEventListener('click', async () => {
      const btn = document.getElementById('accounts-btn');
      const msg = document.getElementById('accounts-msg');
      const list = document.getElementById('accounts-list');
      msg.textContent = '';
      list.innerHTML = '';
      btn.disabled = true;

      const email = (document.getElementById('accounts-email').value || '').trim();
      if (!email) { msg.innerHTML = '<span class="err">Please enter email</span>'; btn.disabled = false; return; }

      try {
        const res = await fetch(`/api/accounts/${encodeURIComponent(email)}`);
        const data = await res.json();
        if (data.success) {
          const accounts = Array.isArray(data.accounts) ? data.accounts
            : (Array.isArray(data.data) ? data.data
               : (data.data && Array.isArray(data.data.accounts) ? data.data.accounts : []));
          if (!accounts || accounts.length === 0) {
            msg.innerHTML = '<span class="err">No accounts linked for this email</span>';
          } else {
            msg.innerHTML = `<span class="ok">Found ${accounts.length} account(s)</span>`;
            list.innerHTML = accounts.map(a => {
              const id = a.account_id || a.id || '';
              const nm = a.name || '';
              const em = a.email || email;
              return `<li class="item">Account ID: ${id}<br/>Name: ${nm}<br/>Email: ${em}</li>`;
            }).join('');
          }
        } else {
          msg.innerHTML = `<span class="err">${data.error || data.message || 'Fetch failed'}</span>`;
        }
      } catch (e) {
        msg.innerHTML = `<span class="err">Fetch failed: ${e.message}</span>`;
      } finally {
        btn.disabled = false;
      }
    });
    // Verification Modal logic
    function showCodeModal() {
      const overlay = document.getElementById('code-modal-overlay');
      const modal = document.getElementById('code-modal');
      const input = document.getElementById('modal-code-input');
      if (overlay && modal) {
        overlay.style.display = 'block';
        modal.style.display = 'block';
        setTimeout(() => { if (input) input.focus(); }, 60);
      }
    }
    function hideCodeModal() {
      const overlay = document.getElementById('code-modal-overlay');
      const modal = document.getElementById('code-modal');
      if (overlay && modal) {
        overlay.style.display = 'none';
        modal.style.display = 'none';
      }
    }
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideCodeModal(); });
    const cancelBtn = document.getElementById('code-cancel');
    if (cancelBtn) cancelBtn.addEventListener('click', hideCodeModal);
    const submitBtn = document.getElementById('code-submit');
    if (submitBtn) submitBtn.addEventListener('click', () => {
      const val = (document.getElementById('modal-code-input').value || '').trim();
      const inline = document.getElementById('verificationCode');
      if (inline) inline.value = val;
      hideCodeModal();
      const connectBtn = document.getElementById('connect-btn');
      if (connectBtn) connectBtn.click();
    });
  </script>

  <!-- Verification Code Modal -->
  <div id="code-modal-overlay" class="modal-overlay"></div>
  <div id="code-modal" class="modal" style="display:none">
    <h3>Verification Code Required</h3>
    <p class="muted">Enter the 6-digit code from Gmail or SMS</p>
    <input id="modal-code-input" placeholder="6-digit code" />
    <div class="modal-actions">
      <button id="code-cancel" class="btn-secondary">Cancel</button>
      <button id="code-submit">Submit</button>
    </div>
  </div>
</body>
